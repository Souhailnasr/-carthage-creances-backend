Créer une intégration complète Angular pour consommer les APIs de validation et rejet des dossiers, avec amélioration des interfaces existantes pour les vues Agent et Chef.

=== ANALYSE DU BACKEND ===

ENDPOINTS DISPONIBLES:

1. VALIDATION (DossierController):
   - PUT /api/dossiers/{id}/valider?chefId={chefId}
     * Retourne: Dossier mis à jour avec statut VALIDE
     * Le dossier passe à: valide=true, statut=VALIDE, dossierStatus=ENCOURSDETRAITEMENT
     * Notification envoyée automatiquement à l'agent créateur

2. REJET (DossierController):
   - PUT /api/dossiers/{id}/rejeter?commentaire={commentaire}
     * Retourne: Dossier mis à jour avec statut REJETE
     * Le dossier passe à: valide=false, statut=REJETE
     * Notification envoyée automatiquement à l'agent créateur

3. CONSULTATION (ValidationDossierController):
   - GET /api/validation/dossiers/en-attente
     * Retourne: ValidationDossier[] avec statut EN_ATTENTE
     * Utilisé par les chefs pour voir les dossiers à valider
   
   - GET /api/validation/dossiers/dossier/{dossierId}
     * Retourne: ValidationDossier[] pour un dossier spécifique
   
   - GET /api/validation/dossiers/agent/{agentId}
     * Retourne: ValidationDossier[] d'un agent (pour voir son historique)

WORKFLOW MÉTIER:
- Agent crée dossier → statut EN_ATTENTE_VALIDATION → ValidationDossier créée avec statut EN_ATTENTE
- Chef crée dossier → validation automatique → ValidationDossier créée avec statut VALIDE
- Chef valide dossier → dossier passe à VALIDE + dossierStatus ENCOURSDETRAITEMENT + notification agent
- Chef rejette dossier → dossier passe à REJETE + notification agent

=== AMÉLIORATION DES INTERFACES ===

1. Améliorer l'interface ValidationDossier existante:
export interface ValidationDossier {
  id: number;
  dossier: Dossier; // Objet Dossier complet (pas juste id)
  agentCreateur: Utilisateur; // Objet Utilisateur complet
  chefValidateur: Utilisateur | null; // null si pas encore validé
  statut: 'EN_ATTENTE' | 'VALIDE' | 'REJETE';
  commentaires: string | null;
  dateCreation: string; // ISO 8601 format
  dateValidation: string | null; // ISO 8601 format, null si EN_ATTENTE
  dateModification?: string | null;
}

2. Améliorer l'interface Dossier pour inclure les champs de validation:
export interface Dossier {
  id: number;
  titre: string;
  description?: string;
  numeroDossier: string;
  montantCreance?: number;
  statut: 'EN_ATTENTE_VALIDATION' | 'VALIDE' | 'REJETE' | 'EN_COURS' | 'CLOTURE';
  dossierStatus: 'ENCOURSDETRAITEMENT' | 'CLOTURE' | 'INCONNU';
  valide: boolean; // true si validé, false sinon
  dateValidation: string | null; // Date de validation
  commentaireValidation?: string | null; // Commentaire si rejeté
  dateCreation: string;
  agentCreateur?: Utilisateur;
  agentResponsable?: Utilisateur;
}

3. Interface Utilisateur (si pas déjà existante):
export interface Utilisateur {
  id: number;
  nom: string;
  prenom: string;
  email: string;
  roleUtilisateur: 'AGENT' | 'CHEF_DEPARTEMENT_DOSSIER' | 'SUPER_ADMIN' | string;
}

=== SERVICE DE VALIDATION ===

Créer/mettre à jour: services/validation-dossier.service.ts

MÉTHODES À IMPLÉMENTER:

1. getDossiersEnAttente(): Observable<ValidationDossier[]>
   - GET /api/validation/dossiers/en-attente
   - Headers: Authorization: Bearer {token}
   - Retourne la liste des dossiers en attente pour les chefs
   - Gérer les erreurs 401 (non authentifié), 403 (non autorisé), 500

2. getValidationsByDossier(dossierId: number): Observable<ValidationDossier[]>
   - GET /api/validation/dossiers/dossier/{dossierId}
   - Retourne toutes les validations d'un dossier

3. getValidationsByAgent(agentId: number): Observable<ValidationDossier[]>
   - GET /api/validation/dossiers/agent/{agentId}
   - Utilisé par l'agent pour voir son historique de validations

4. validerDossier(dossierId: number, chefId: number): Observable<Dossier>
   - PUT /api/dossiers/{dossierId}/valider?chefId={chefId}
   - Headers: Authorization: Bearer {token}
   - Retourne le Dossier mis à jour avec statut VALIDE
   - Le backend met automatiquement à jour la ValidationDossier et envoie notification
   - Gérer les erreurs: 400 (dossier non trouvé/déjà validé), 401, 403, 500

5. rejeterDossier(dossierId: number, commentaire: string): Observable<Dossier>
   - PUT /api/dossiers/{dossierId}/rejeter?commentaire={commentaire}
   - Headers: Authorization: Bearer {token}
   - commentaire est OBLIGATOIRE (ne pas envoyer si vide)
   - Retourne le Dossier mis à jour avec statut REJETE
   - Le backend met automatiquement à jour la ValidationDossier et envoie notification
   - Gérer les erreurs: 400 (dossier non trouvé/déjà traité), 401, 403, 500

GESTION DES ERREURS:
- Utiliser catchError de RxJS
- Intercepter les erreurs HTTP et retourner des messages lisibles
- Logger les erreurs pour le debugging
- Retourner des Observables avec of([]) ou throwError() selon le cas

UTILISER:
- HttpClient injecté
- Base URL depuis environment (http://localhost:8080/api)
- Interceptor pour ajouter automatiquement le token JWT
- RxJS operators: catchError, map, tap, finalize

=== COMPOSANT CHEF: LISTE DES DOSSIERS EN ATTENTE ===

Créer: components/dossiers-en-attente/dossiers-en-attente.component.ts

FONCTIONNALITÉS:

1. AFFICHAGE:
   - Tableau Angular Material avec colonnes: Numéro dossier, Titre, Agent créateur (nom + prénom), Date création, Statut, Actions
   - Badge MatChip pour statut EN_ATTENTE (orange)
   - Loading spinner pendant le chargement
   - Message "Aucun dossier en attente" si liste vide

2. ACTIONS:
   - Bouton "Valider" (vert, MatButton) qui ouvre un MatDialog de confirmation
   - Bouton "Rejeter" (rouge, MatButton) qui ouvre un MatDialog avec formulaire
   - Bouton "Voir détails" pour afficher les détails complets

3. DIALOG DE VALIDATION:
   - Titre: "Valider le dossier"
   - Afficher: Numéro dossier, Titre
   - Champ optionnel pour commentaire de validation
   - Boutons: "Valider" (primaire) et "Annuler"
   - Au clic sur "Valider": appeler validerDossier() du service
   - Afficher MatSnackBar "Dossier validé avec succès" en cas de succès
   - Rafraîchir la liste après validation

4. DIALOG DE REJET:
   - Titre: "Rejeter le dossier"
   - Afficher: Numéro dossier, Titre
   - Champ REQUIS (textarea) pour commentaire de rejet avec validation
   - Avertissement: "Cette action rejettera le dossier et notifiera l'agent créateur"
   - Boutons: "Rejeter" (warn) et "Annuler"
   - Au clic sur "Rejeter": appeler rejeterDossier() du service avec commentaire
   - Afficher MatSnackBar "Dossier rejeté" en cas de succès
   - Rafraîchir la liste après rejet

5. GESTION D'ÉTAT:
   - Loading pendant le chargement initial
   - Loading pendant validation/rejet (désactiver boutons)
   - Gestion des erreurs avec MatSnackBar (messages d'erreur)
   - Rafraîchissement automatique après chaque action

UTILISER:
- Angular Material: MatTable, MatButton, MatDialog, MatSnackBar, MatChip, MatProgressSpinner
- Reactive Forms pour le formulaire de rejet
- Service de validation injecté
- Service d'authentification pour obtenir l'ID du chef connecté
- ChangeDetectionStrategy.OnPush si possible

=== COMPOSANT AGENT: HISTORIQUE DES VALIDATIONS ===

Créer: components/mes-validations/mes-validations.component.ts

FONCTIONNALITÉS:

1. AFFICHAGE:
   - Tableau Angular Material avec colonnes: Numéro dossier, Titre, Statut validation, Date création, Date validation, Chef validateur, Commentaires
   - Badges colorés MatChip pour les statuts:
     * EN_ATTENTE: orange (en attente de validation)
     * VALIDE: vert (validé)
     * REJETE: rouge (rejeté)
   - Loading spinner pendant le chargement

2. FILTRES:
   - MatSelect pour filtrer par statut (Tous, EN_ATTENTE, VALIDE, REJETE)
   - MatInput pour recherche par numéro de dossier ou titre
   - Application des filtres en temps réel avec debounceTime(300)

3. DÉTAILS:
   - Clic sur une ligne pour voir les détails complets
   - Afficher dans un MatDialog ou MatExpansionPanel:
     * Informations complètes du dossier
     * Commentaire de validation/rejet si disponible
     * Nom complet du chef validateur si validé/rejeté
     * Date exacte de validation

4. STATISTIQUES (optionnel):
   - Cards MatCard affichant:
     * Total dossiers créés
     * En attente
     * Validés
     * Rejetés

5. GESTION D'ÉTAT:
   - Loading pendant le chargement
   - Message "Aucune validation trouvée" si liste vide
   - Pagination si nécessaire (MatPaginator)

UTILISER:
- Angular Material: MatTable, MatSelect, MatInput, MatChip, MatCard, MatPaginator
- Service de validation injecté
- Service d'authentification pour obtenir l'ID de l'agent connecté
- RxJS pour les filtres (combineLatest, debounceTime, distinctUntilChanged)

=== GESTION DES ERREURS ===

Créer un service helper ou utiliser MatSnackBar directement:

1. Messages de succès:
   - "Dossier validé avec succès" (vert)
   - "Dossier rejeté" (orange/warn)
   - "Dossier chargé avec succès"

2. Messages d'erreur:
   - "Erreur lors du chargement des dossiers"
   - "Erreur lors de la validation du dossier"
   - "Erreur lors du rejet du dossier"
   - "Vous n'avez pas les droits pour valider ce dossier" (403)
   - "Session expirée, veuillez vous reconnecter" (401)
   - Messages spécifiques du backend si disponibles

=== SÉCURITÉ ===

1. Vérifier le rôle de l'utilisateur avant d'afficher les composants:
   - Chef: peut voir /dossiers/en-attente et valider/rejeter
   - Agent: peut voir /mes-validations (ses propres validations)

2. Utiliser un Guard pour protéger les routes:
   - Route /dossiers/en-attente: accessible seulement aux CHEF_DEPARTEMENT_DOSSIER et SUPER_ADMIN
   - Route /mes-validations: accessible à tous les utilisateurs authentifiés

3. Interceptor pour l'authentification:
   - Ajouter automatiquement Authorization: Bearer {token} à toutes les requêtes
   - Gérer les erreurs 401 et rediriger vers login si nécessaire

=== EXEMPLE D'UTILISATION ===

Dans le composant chef:
export class DossiersEnAttenteComponent implements OnInit {
  displayedColumns = ['numeroDossier', 'titre', 'agentCreateur', 'dateCreation', 'statut', 'actions'];
  dataSource = new MatTableDataSource<ValidationDossier>();
  loading = false;
  
  constructor(
    private validationService: ValidationDossierService,
    private authService: AuthService,
    private snackBar: MatSnackBar,
    private dialog: MatDialog
  ) {}
  
  ngOnInit() {
    this.loadDossiersEnAttente();
  }
  
  loadDossiersEnAttente() {
    this.loading = true;
    this.validationService.getDossiersEnAttente()
      .pipe(
        finalize(() => this.loading = false),
        catchError(error => {
          this.snackBar.open('Erreur lors du chargement', 'Fermer', { duration: 3000 });
          return of([]);
        })
      )
      .subscribe(validations => {
        this.dataSource.data = validations;
      });
  }
  
  validerDossier(validation: ValidationDossier) {
    const dialogRef = this.dialog.open(ValidationDialogComponent, {
      width: '500px',
      data: { dossier: validation.dossier }
    });
    
    dialogRef.afterClosed().subscribe(result => {
      if (result?.confirmed) {
        const chefId = this.authService.getCurrentUser().id;
        this.validationService.validerDossier(validation.dossier.id, chefId)
          .subscribe({
            next: () => {
              this.snackBar.open('Dossier validé avec succès', 'Fermer', { duration: 3000 });
              this.loadDossiersEnAttente();
            },
            error: (error) => {
              const message = error.error?.message || 'Erreur lors de la validation';
              this.snackBar.open(message, 'Fermer', { duration: 5000 });
            }
          });
      }
    });
  }
  
  rejeterDossier(validation: ValidationDossier) {
    const dialogRef = this.dialog.open(RejetDialogComponent, {
      width: '500px',
      data: { dossier: validation.dossier }
    });
    
    dialogRef.afterClosed().subscribe(result => {
      if (result?.commentaire) {
        this.validationService.rejeterDossier(validation.dossier.id, result.commentaire)
          .subscribe({
            next: () => {
              this.snackBar.open('Dossier rejeté', 'Fermer', { duration: 3000 });
              this.loadDossiersEnAttente();
            },
            error: (error) => {
              const message = error.error?.message || 'Erreur lors du rejet';
              this.snackBar.open(message, 'Fermer', { duration: 5000 });
            }
          });
      }
    });
  }
}

=== CONFIGURATION ===

1. Environment:
export const environment = {
  apiUrl: 'http://localhost:8080/api'
};

2. Module imports:
- HttpClientModule
- ReactiveFormsModule
- MatTableModule, MatButtonModule, MatDialogModule, MatSnackBarModule, MatChipModule, MatProgressSpinnerModule, MatSelectModule, MatInputModule, MatPaginatorModule

3. Interceptor (si pas déjà créé):
@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    const token = localStorage.getItem('token');
    if (token) {
      req = req.clone({
        setHeaders: { Authorization: `Bearer ${token}` }
      });
    }
    return next.handle(req).pipe(
      catchError(error => {
        if (error.status === 401) {
          // Rediriger vers login
        }
        return throwError(error);
      })
    );
  }
}

IMPORTANT:
- Tous les appels API doivent inclure le token JWT dans le header Authorization
- Gérer les cas où le token est expiré (401) et rediriger vers login
- Valider les formulaires avant de soumettre (commentaire obligatoire pour rejet)
- Rafraîchir les données après chaque action (validation/rejet)
- Afficher des messages de feedback clairs à l'utilisateur
- Désactiver les boutons pendant les appels API pour éviter les doubles soumissions

